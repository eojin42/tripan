<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tripan.app.mapper.MemberMapper">
<select id="findById" parameterType="String" resultType="com.tripan.app.domain.dto.MemberDto">
		SELECT m1.member_id, m1.login_id, m1.password, m1.username, m1.email,
			   m1.status, m1.role, NVL(m1.failure_cnt, 0) failure_cnt,
			   m1.provider AS sns_provider, m1.provider_id AS sns_id,
			   m2.nickname, m2.profile_image AS profile_photo, m2.phone_number AS tel
		FROM member1 m1
		LEFT OUTER JOIN member2 m2 ON m1.member_id = m2.member_id
		WHERE m1.login_id = #{login_id}
	</select>

	<select id="findByLoginId" parameterType="String" resultType="com.tripan.app.domain.dto.MemberDto">
		SELECT m1.member_id, m1.login_id, m1.password, m1.username, m1.email,
			   m1.status, m1.role, NVL(m1.failure_cnt, 0) failure_cnt,
			   m1.provider AS sns_provider, m1.provider_id AS sns_id,
			   m2.nickname, m2.profile_image AS profile_photo, m2.phone_number AS tel
		FROM member1 m1
		LEFT OUTER JOIN member2 m2 ON m1.member_id = m2.member_id
		WHERE m1.login_id = #{login_id}
	</select>

	<select id="checkFailureCount" parameterType="String" resultType="Integer">
		SELECT NVL(failure_cnt, 0) failure_cnt
		FROM member1
		WHERE login_id = #{login_id}
	</select>
	
	<update id="updateFailureCount" parameterType="String">
		UPDATE member1 SET failure_cnt = NVL(failure_cnt, 0) + 1
		WHERE login_id = #{login_id}
	</update>

	<update id="updateLastLoginId" parameterType="String">
		DECLARE
			v_member_id NUMBER;
		BEGIN
			SELECT member_id INTO v_member_id FROM member1 WHERE login_id = #{login_id};
			
			UPDATE member1 SET failure_cnt = 0 WHERE member_id = v_member_id;
			UPDATE member2 SET last_login_at = SYSDATE WHERE member_id = v_member_id;
		END;
	</update>

	<update id="updateMemberEnabled" parameterType="map">
		UPDATE member1 SET status = 'INACTIVE'
		<where>
			<choose>
				<when test="login_id != null">
					login_id = #{login_id}
				</when>
				<otherwise>
					member_id = #{member_id}
				</otherwise>
			</choose>
		</where>
	</update>
</mapper>